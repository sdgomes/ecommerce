@model ClientDTO

@{
ViewBreadcrumbs breadcrumbs = new();
breadcrumbs.Title = "Checkout";
breadcrumbs.Breadcrumbs = new BreadcrumbsDTO[]{
new BreadcrumbsDTO("Início", "/", "fa-solid fa-house"),
new BreadcrumbsDTO("Produtos", "./shop"),
new BreadcrumbsDTO("Checkout")
};

ViewData["Title"] = breadcrumbs.Title;
}

@(await Component.InvokeAsync<BreadcrumbsViewComponent>(breadcrumbs))

    <section class="checkout-wrapper section">
        <div class="container mx-auto sm:px-4">
            <div class="flex flex-wrap  justify-center">
                <div class="lg:w-2/3 px-4">
                    <div class="checkout-steps-form-style-1">
                        <div class="join join-vertical w-full space-y-5">
                            <div class="collapse collapse-arrow join-item border border-base-300 !rounded-[3px]">
                                <input readonly autocomplete="off" type="radio" name="my-accordion-1" checked />
                                <div class="collapse-title font-bold !bg-white !text-gray-800 border-b">
                                    Informações pessoais
                                </div>
                                <div class="collapse-content bg-white">
                                    <div class="flex flex-wrap ">
                                        <div class="md:w-2/3 px-4">
                                            <div class="single-form form-default">
                                                <label>Nome</label>
                                                <div class="form-input form">
                                                    <input readonly autocomplete="off" type="text"
                                                        value="@Model.Client.Nome.Capitalize() @Model.Client.Sobrenome.Capitalize()">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="md:w-1/3 px-4">
                                            <div class="single-form form-default">
                                                <label>RG</label>
                                                <div class="form-input form">
                                                    <input readonly autocomplete="off" type="text"
                                                        value="**.***.@Model.Client.RG.Split('.')[2]">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="md:w-1/3 px-4">
                                            <div class="single-form form-default">
                                                <label>CPF</label>
                                                <div class="form-input form">
                                                    <input readonly autocomplete="off" type="text"
                                                        value="***.***.@Model.Client.CPF.Split('.')[2]">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="md:w-1/3 px-4">
                                            <div class="single-form form-default">
                                                <label>Celular</label>
                                                <div class="form-input form">
                                                    <input readonly autocomplete="off" type="text"
                                                        value="@Model.Client.Celular">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="md:w-1/3 px-4">
                                            <div class="single-form form-default">
                                                <label>Telefone (fixo)</label>
                                                <div class="form-input form">
                                                    <input readonly autocomplete="off" type="text"
                                                        value="@Model.Client.Telefone">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="md:w-1/3 px-4">
                                            <div class="single-form form-default">
                                                <label>Gênero</label>
                                                <div class="form-input form">
                                                    <input readonly autocomplete="off" type="text"
                                                        value='@Model.Client.Genero.Replace("_", " ").Capitalize()'>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="md:w-1/3 px-4">
                                            <div class="single-form form-default">
                                                <label>Data nascimento</label>
                                                <div class="form-input form">
                                                    <input readonly autocomplete="off" type="text"
                                                        value='@Model.Client.DataNascimento.ToString("dd/MM/yyyyy")'>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="collapse collapse-arrow join-item border border-base-300 !rounded-[3px]">
                                <input readonly autocomplete="off" type="radio" name="my-accordion-2" checked />
                                <div class="collapse-title font-bold !bg-white !text-gray-800 border-b">
                                    Endereço para envio
                                </div>
                                <div class="collapse-content bg-white">

                                    <div class="flex flex-wrap gap-3">
                                        @foreach (var (address, index) in Model.Adresses.Select((address, index) =>
                                        (address, index)))
                                        {
                                        <div class="w-1/2 card bg-base-200 rounded">
                                            <div class="card-body px-3 py-3.5">
                                                <label class="flex items-center gap-2">
                                                    <input class="accent-yellow-400 h-[25px] w-[25px]" type="radio"
                                                        name="enderecoEntrega" value="@address.IdEndereco">
                                                    @address.NomeEndereco
                                                </label>

                                                <div class="flex flex-wrap mt-4 px-3">
                                                    <div class="text-base w-full">@address.CEP</div>
                                                    <div class="w-full text-gray-800">
                                                        @address.TipoLogradouro.Capitalize(),
                                                        @address.TipoResidencia.Capitalize()</div>
                                                    <div class="text-base w-full text-gray-800">@address.Logradouro,
                                                        @address.Numero - @address.Bairro, @address.Cidade -
                                                        @address.Estado</div>
                                                    <hr>
                                                    <div>@address.Complemento</div>
                                                    <div>@address.Frase</div>
                                                </div>
                                            </div>
                                        </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="collapse collapse-arrow join-item border border-base-300 !rounded-[3px]">
                                <input readonly autocomplete="off" type="radio" name="my-accordion-3" checked />
                                <div class="collapse-title font-bold !bg-white !text-gray-800 border-b">
                                    Forma de pagamento
                                </div>
                                <div class="collapse-content bg-white">

                                    <div class="flex flex-wrap gap-3">
                                        @foreach (var (card, index) in Model.Cards.Select((card, index) => (card,
                                        index)))
                                        {
                                        <label
                                            class="w-96 h-56 m-auto bg-red-100 rounded-xl relative text-white shadow-2xl transition-transform transform hover:scale-110">

                                            <img class="relative object-cover w-full h-full rounded-xl"
                                                src="https://i.imgur.com/kGkSg1v.png">

                                            <div class="w-full px-8 absolute top-8">

                                                <input
                                                    class="accent-yellow-400 absolute right-[1.25rem] bottom-0 h-[25px] w-[25px]"
                                                    type="checkbox" name="cartaoPagamento" value="@card.IdCartao">

                                                <div class="flex justify-between">
                                                    <div class="">
                                                        <p class="font-light">
                                                            Nome
                                                        <p class="font-medium tracking-widest">
                                                            @card.NomeTitular.Capitalize()
                                                        </p>
                                                    </div>
                                                    <img class="w-14 h-14"
                                                        src="~/img/images/payment/@(card.IdBandeira).webp" />
                                                </div>
                                                <div class="pt-1">
                                                    <p class="font-light">
                                                        Número Cartão
                                                    <p class="font-medium tracking-more-wider">
                                                        *** *** *** @card.Numero.Split(' ')[3]
                                                    </p>
                                                </div>
                                                <div class="pt-6 pr-6">
                                                    <div class="flex justify-between">
                                                        <div class="">
                                                            <p class="font-light text-xs">
                                                                Válidade até
                                                            <p class="font-medium tracking-wider text-sm">
                                                                @card.DataValidade.Split("-")[1]/@card.DataValidade.Split("-")[0]
                                                            </p>
                                                        </div>

                                                        <div class="">
                                                            <p class="font-light text-xs">
                                                                CVV
                                                            <p class="font-bold tracking-more-wider text-sm">
                                                                ···
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:w-1/3 px-4">
                    <div class="checkout-sidebar">
                        <div class="checkout-sidebar-coupon">
                            <p>Aplique o cupom para obter desconto!</p>
                            <form>
                                <div class="single-form form-default">
                                    <div class="form-input form">
                                        <input autocomplete="off" type="text" placeholder="Código do cupom">
                                    </div>
                                    <div class="button">
                                        <button type="button" data-action='desconto'
                                            class="btn !w-fit !flex !text-gray-800 hover:!text-white min-h-0">Aplicar</button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="checkout-sidebar-coupon mt-5">
                            <p>Aplique o cupom para obter desconto!</p>
                            <form>
                                <div class="single-form form-default">
                                    <div class="form-input form">
                                        <input autocomplete="off" type="text" placeholder="Insira seu CEP"
                                            data-mask="00000-000">
                                    </div>
                                    <div class="button">
                                        <button type="button" data-action='frete'
                                            class="btn !w-fit !flex !text-gray-800 hover:!text-white min-h-0">Cálcular
                                            frete</button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="checkout-sidebar-price-table mt-30">
                            <h5 class="title">Tabela de preços</h5>

                            <div class="sub-total-price">
                                <div class="total-price">
                                    <p class="value">Subtotal do carrinho:</p>
                                    <p class="price" menu-total-amount>R$ 0,00</p>
                                </div>
                                <div class="total-price shipping">
                                    <p class="value">Frete:</p>
                                    <p class="price" valor-frete>R$ 0,00</p>
                                </div>
                                <div class="total-price discount">
                                    <p class="value">Descontos:</p>
                                    <p class="price" total-descontos>R$ 0,00</p>
                                </div>
                            </div>

                            <div class="total-payable">
                                <div class="payable-price">
                                    <p class="value">Total a pagar:</p>
                                    <p class="price" total-compra>R$ 0,00</p>
                                </div>
                            </div>
                            <div class="price-table-btn button">
                                <a comprar
                                    class="btn !bg-[#130235] !text-white !flex !itens-center hover:!bg-[#372853] hover:!text-gray-800 btn-alt">Comprar</a>
                            </div>
                        </div>
                        <div class="checkout-sidebar-banner mt-30">
                            <a asp-action="Index" asp-controller="Shop">
                                <img src="~/img/images/banner/banner.jpg" alt="...">
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>


    @section Scripts {
    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function (event) {
            onDomChange(function () {
                setTimeout(() => {
                    $.applyDataMask('[data-mask');
                }, 125);
            });
        });

        $(document).on("click", '[comprar]', function () {
            if ($('[name="enderecoEntrega"]:checked').length == 0)
                Swal.fire({
                    icon: 'warning',
                    title: "Atenção!",
                    text: 'Selecione um endereço para entrega.',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    allowEnterKey: false,
                    confirmButtonText: "Tentar novamente",
                    reverseButtons: true,
                    customClass: {
                        confirmButton: "!bg-[#ffcc00] !text-gray-800",
                    },
                });
            if ($('[name="cartaoPagamento"]:checked').length == 0)
                Swal.fire({
                    icon: 'warning',
                    title: "Atenção!",
                    text: 'Escolha pelo menos um cartão para efetuar o pagamento.',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    allowEnterKey: false,
                    confirmButtonText: "Tentar novamente",
                    reverseButtons: true,
                    customClass: {
                        confirmButton: "!bg-[#ffcc00] !text-gray-800",
                    },
                });

            var cartoes = [];
            $('[name="cartaoPagamento"]:checked').each(function (index, element) {
                cartoes.push($(element).val())
            });

            var registro = {
                produtos: Carrinho.getItems(),
                idEndereco: $('[name="enderecoEntrega"]:checked').val(),
                idCartoes: cartoes,
                idCliente: $('[name="idCliente"]').val(),
                subtotal: $('[menu-total-amount]').text(),
                frete: $('[valor-frete]').text(),
                descontos: $('[total-descontos]').text(),
                total: $('[total-compra]').text()
            }

            localStorage.setItem("registro-compra", JSON.stringify(registro))
        })

        $(document).on("click", '[data-action="frete"]', function () {
            $button = $(this);
            $input = $button.parents('form').find('input');

            if ($input.val().trim() == "")
                Toast.fire({
                    icon: "error",
                    title: "O campo CEP precisa ser preenchido."
                });
            else {
                $button.html(`<span class="loading loading-spinner loading-sm"></span> Calculando`)

                $.ajax({
                    type: "GET",
                    url: `/calcular/frete/${$input.val()}`,
                    success: function (data) {
                        $button.html(`Cálcular frete`)

                        Toast.fire({
                            icon: data.response.success ? "success" : "error",
                            title: data.response.message
                        });

                        if (data.response.success) {
                            $input.val("");
                            localStorage.setItem("frete", data.response.preco)
                            $('[valor-frete]').html(data.response.frete)
                            Carrinho.AtualizaFreCalculos()
                        }
                    },
                    error: function (response) {
                        console.log(response);
                    },
                });
            }
        })

        $(document).on("click", "[data-action='desconto']", function () {
            $button = $(this);
            $input = $button.parents('form').find('input');

            if ($input.val().trim() == "")
                Toast.fire({
                    icon: "error",
                    title: "Informe um código para aplicar o cupom."
                });
            else {
                $button.html(`<span class="loading loading-spinner loading-sm"></span> Calculando`)

                $.ajax({
                    type: "GET",
                    url: `/buscar/desconto/${$input.val()}`,
                    success: function (data) {
                        $button.html(`Aplicar`)

                        Toast.fire({
                            icon: data.response.success ? "success" : "error",
                            title: data.response.message
                        });
                    },
                    error: function (response) {
                        console.log(response);
                    },
                });
            }
        })
    </script>
    }