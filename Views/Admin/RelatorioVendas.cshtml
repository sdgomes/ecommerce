@{
var url = Context.Request.RouteValues;
var codigo = url["Codigo"].ToString();

ViewBreadcrumbs breadcrumbs = new();
breadcrumbs.Title = "Relatório Vendas";
breadcrumbs.Breadcrumbs = new BreadcrumbsDTO[] {
new BreadcrumbsDTO("Início", "/", "fa-solid fa-house"),
new BreadcrumbsDTO("Perfil", Url.Action("Index", "Admin", new{ codigo }), "fa-solid fa-user"),
new BreadcrumbsDTO("Relatório")
};

ViewData["Title"] = breadcrumbs.Title;
}

@(await Component.InvokeAsync<BreadcrumbsViewComponent>(breadcrumbs))


    <header class="bg-gray-100 text-white py-6">
        <div class="container mx-auto text-left">
            <h1 class="text-2xl font-bold">Vendas</h1>
            <p class="text-base text-yellow-600 mt-2">
                Acompanhe o andamento das vendas, assim você melhora sua gestão comercial.
            </p>
        </div>
    </header>

    <main class="container mx-auto py-8">
        <div class="space-y-4">
            <form id="filtro" class="flex items-end gap-5 w-[175px]">
                <label class="form-control w-full">
                    <div class="label">
                        <span class="label-text-alt">Inicio</span>
                    </div>
                    <input type="date" name="inicio" placeholder="Type here" class="input input-bordered w-full" />
                </label>

                <label class="form-control w-full">
                    <div class="label">
                        <span class="label-text-alt">Fim</span>
                    </div>
                    <input type="date" name="fim" placeholder="Type here" class="input input-bordered w-full" />
                </label>

                <button type="button" id="filtro_data" class="btn btn-primary">Filtrar</button>
                <button type="button" id="limpar_filtro" style="display: none;" class="btn btn-warning"><i
                        class="fa-solid fa-filter-circle-xmark"></i></button>
            </form>

            <div id="container_geral"></div>

            <hr>

            <div id="container_produto"></div>
        </div>
    </main>


    @section Scripts {
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/data.js"></script>
    <script src="https://code.highcharts.com/modules/series-label.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <script>
        $(function () {

            const defautl = {

                chart: {
                    type: 'spline',
                    scrollablePlotArea: {
                        minWidth: 700
                    }
                },

                title: {
                    text: 'Análise por Produto',
                    align: 'left'
                },

                subtitle: {
                    text: 'Análise de vendas: Quantidade vendida pro produto. Para um melhor resultado filtre os produtos.',
                    align: 'left'
                },

                xAxis: {
                    tickWidth: 0,
                    gridLineWidth: 1,
                    labels: {
                        align: 'left',
                        x: 3,
                        y: -3
                    }
                },

                yAxis: [{
                    title: {
                        text: 'Qnt. Vendas'
                    },
                    labels: {
                        align: 'left',
                        x: 3,
                        y: 16,
                        format: '{value:.,0f}'
                    },
                    showFirstLabel: false
                }],

                legend: {
                    align: 'left',
                    verticalAlign: 'top',
                    borderWidth: 0
                },

                tooltip: {
                    shared: true,
                    crosshairs: true
                },

                plotOptions: {
                    series: {
                        cursor: 'pointer',
                        marker: {
                            lineWidth: 1
                        }
                    }
                },
                exporting: {
                    enabled: false
                }, credits: {
                    enabled: false
                },
            }

            const dataJsonUpdate = [
                [
                    null, "Qnt. Venda", "Teste"
                ],
                ["24/01/2021", 4, 5],
                ["25/02/2021", 2, 6
                ],
                [
                    "01/03/2021",
                    7, 4
                ],
                [
                    "03/03/2022",
                    8, 5
                ],
                [
                    "24/03/2022",
                    1, 4
                ],
                [
                    "22/04/2022",
                    1, 7
                ],
                [
                    "24/04/2022",
                    2, 6
                ],
                [
                    "01/01/2023",
                    1, 8
                ],
                [
                    "24/01/2023",
                    9, 5
                ],
                [
                    "24/02/2023",
                    0, 3
                ]
            ]

            Highcharts.setOptions({
                lang: {
                    months: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
                    shortMonths: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                    weekdays: ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'],
                    loading: ['Atualizando o gráfico...aguarde'],
                    contextButtonTitle: 'Exportar gráfico',
                    decimalPoint: ',',
                    thousandsSep: '.',
                    downloadJPEG: 'Baixar imagem JPEG',
                    downloadPDF: 'Baixar arquivo PDF',
                    downloadPNG: 'Baixar imagem PNG',
                    downloadSVG: 'Baixar vetor SVG',
                    printChart: 'Imprimir gráfico',
                    rangeSelectorFrom: 'De',
                    rangeSelectorTo: 'Para',
                    rangeSelectorZoom: 'Zoom',
                    resetZoom: 'Limpar Zoom',
                    resetZoomTitle: 'Voltar Zoom para nível 1:1',
                }
            });

            var chartGeral, chartProduto;


            // var chartProduto = Highcharts.chart('container_produto', {
            //     ...defautl, series: [{
            //         name: 'Installation & Developers',
            //         data: [
            //             ["04/02/2023", 43934], ["11/07/2020", 48656], ["06/20/2024", 65165], ["01/28/2023", 81827], ["12/17/2019", 112143], ["05/16/2023", 142383],
            //             ["05/11/2022", 171533], ["03/21/2021", 165174], ["04/14/2021", 155157], ["12/27/2023", 161454], ["06/20/2024", 154610]
            //         ]
            //     }, {
            //         name: 'Manufacturing',
            //         data: [
            //             ["08/18/2023", 24916], ["08/23/2023", 37941], ["09/13/2021", 29742], ["12/10/2021", 29851], ["03/16/2023", 32490], ["12/14/2021", 30282],
            //             ["02/22/2024", 38121], ["03/09/2021", 36885], ["06/06/2021", 33726], ["04/19/2021", 34243], ["03/01/2024", 31050]
            //         ]
            //     }],
            // });



            $(document).on('click', '#limpar_filtro', function () {
                $(this).hide();
                iniciaGrafico();
            });

            $(document).on('click', '#filtro_data', function () {
                $button = $(this);
                const content = $button.html();

                const data = $button.parents('form').serializeJson();
                if (data.inicio.trim() == "" || data.fim.trim() == "") {
                    Swal.fire({
                        position: "center",
                        icon: "info",
                        title: "Atenção!",
                        text: "É necessário escolher um range de data, de inicio e fim.",
                        showConfirmButton: false,
                        timer: 1500
                    })
                    return false;
                }

                $('#limpar_filtro').show();

                $button.html(`<span class="loading loading-spinner loading-sm"></span> Filtrando`)

                $.ajax({
                    type: "POST",
                    url: `/relatorio/geral/range`,
                    data: data,
                    success: function (response) {
                        const geral = [["Qnt. Venda"]]
                        response.data.geral.forEach(element => {
                            geral.push([element.dataVenda, element.quantidade]);
                        });

                        chartGeral.destroy();
                        chartGeral = new Highcharts.Chart('container_geral', {
                            ...defautl, data: {
                                rows: geral
                            }
                        });

                        let data = response.data.produto;
                        let result = [...new Set(data.map(x => x.nome))].map(x => {
                            return {
                                name: x,
                                data: data.filter(y => y.nome == x)[0].data.map(e => [e.dataVenda, e.quantidade])
                            }
                        })

                        chartProduto.destroy();
                        chartProduto = Highcharts.chart('container_produto', {
                            ...defautl, series: result,
                        });

                        setTimeout(() => {
                            $button.html(`<i class="fa-solid fa-check"></i> Filtrado`);
                            setTimeout(() => {
                                $button.html(content)
                            }, 325);
                        }, 325);
                    },
                    error: function (response) {
                        console.log(response);
                    },
                });
            })

            const iniciaGrafico = () => {
                $.ajax({
                    type: "POST",
                    url: `/relatorio/geral`,
                    success: function (response) {
                        const geral = [[null, "Qnt. Venda"]]
                        response.data.geral.forEach(element => {
                            geral.push([element.dataVenda, element.quantidade]);
                        });

                        chartGeral = new Highcharts.Chart('container_geral', {
                            ...defautl, data: {
                                rows: geral
                            }
                        });

                        let data = response.data.produto;
                        let result = [...new Set(data.map(x => x.nome))].map(x => {
                            return {
                                name: x,
                                data: data.filter(y => y.nome == x)[0].data.map(e => [e.dataVenda, e.quantidade])
                            }
                        })

                        chartProduto = Highcharts.chart('container_produto', {
                            ...defautl, series: result,
                        });
                    },
                    error: function (response) {
                        console.log(response);
                    },
                });
            }

            iniciaGrafico();
        });

    </script>
    }